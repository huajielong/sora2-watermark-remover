# Sora2WatermarkRemover 工程项目说明书

## 1. 项目概述

Sora2WatermarkRemover是一个基于深度学习的视频水印检测和清除系统，专为Sora2 AI生成视频设计。本项目说明书旨在提供项目结构说明、开发环境搭建指南、代码贡献规范和部署说明，帮助开发者快速了解和参与项目开发。

## 2. 项目目录结构

```
Sora2WatermarkRemover/
├── app.py                 # Web界面主入口
├── desktop.py             # 桌面GUI应用入口
├── example.py             # 命令行使用示例
├── start_server.py        # Web服务启动脚本
├── requirements.txt       # Python依赖列表
├── pyproject.toml         # 项目配置和构建信息
├── uv.lock                # uv依赖锁定文件
├── resources/             # 资源文件目录
│   ├── best.pt            # 预训练的YOLO检测模型
│   ├── app.png            # Web应用截图
│   └── dog_vs_sam.mp4     # 示例视频
├── outputs/               # 处理结果输出目录
├── sora2wm/               # 核心代码包
│   ├── __init__.py        # 包初始化
│   ├── core.py            # 核心处理类
│   ├── configs.py         # 配置管理
│   ├── watermark_detector.py # 水印检测模块
│   ├── watermark_remover.py  # 水印移除模块
│   ├── utils/             # 工具函数
│   │   ├── __init__.py
│   │   ├── devices_utils.py  # 设备选择和管理
│   │   ├── ffmpeg_utils.py   # FFmpeg工具封装
│   │   └── video_utils.py    # 视频处理工具
│   └── server/            # Web服务相关
│       ├── __init__.py
│       ├── router.py      # API路由定义
│       ├── tasks.py       # 任务管理
│       └── models.py      # 数据模型
└── tests/                 # 测试代码
    ├── test_ffmpeg_setup.py  # FFmpeg配置测试
    ├── test_detector.py      # 检测模块测试
    └── test_remover.py       # 移除模块测试
```

## 3. 系统架构与组件说明

### 3.1 核心模块

| 模块 | 职责 | 文件位置 | 引用 |
|------|------|----------|------|
| 核心处理模块 | 协调整个水印移除流程 | sora2wm/core.py | <mcfile name="core.py" path="d:\python\Sora2WatermarkRemover\sora2wm\core.py"></mcfile> |
| 水印检测模块 | 检测视频中的水印位置 | sora2wm/watermark_detector.py | <mcfile name="watermark_detector.py" path="d:\python\Sora2WatermarkRemover\sora2wm\watermark_detector.py"></mcfile> |
| 水印移除模块 | 根据检测结果清除水印 | sora2wm/watermark_remover.py | <mcfile name="watermark_remover.py" path="d:\python\Sora2WatermarkRemover\sora2wm\watermark_remover.py"></mcfile> |
| 设备管理工具 | 设备选择和资源管理 | sora2wm/utils/devices_utils.py | <mcfile name="devices_utils.py" path="d:\python\Sora2WatermarkRemover\sora2wm\utils\devices_utils.py"></mcfile> |

### 3.2 界面与服务模块

| 模块 | 职责 | 文件位置 | 引用 |
|------|------|----------|------|
| Web界面 | 提供用户友好的交互界面 | app.py | <mcfile name="app.py" path="d:\python\Sora2WatermarkRemover\app.py"></mcfile> |
| 桌面GUI | 提供桌面应用程序 | desktop.py | <mcfile name="desktop.py" path="d:\python\Sora2WatermarkRemover\desktop.py"></mcfile> |
| Web服务 | 提供REST API接口 | start_server.py | <mcfile name="start_server.py" path="d:\python\Sora2WatermarkRemover\start_server.py"></mcfile> |
| API路由 | 定义API端点和处理逻辑 | sora2wm/server/router.py | <mcfile name="router.py" path="d:\python\Sora2WatermarkRemover\sora2wm\server\router.py"></mcfile> |

## 4. 开发环境搭建

### 4.1 前提条件

- **操作系统**：Windows 10/11, macOS, 或 Linux
- **Python**：3.9 或更高版本
- **FFmpeg**：4.0 或更高版本
- **GPU支持**（可选）：
  - NVIDIA GPU：CUDA 11.7+ 和 cuDNN 8.5+
  - Apple Silicon：macOS 12.0+

### 4.2 环境设置步骤

#### 4.2.1 使用uv安装（推荐）

```bash
# 安装uv（如果尚未安装）
pip install uv

# 使用uv同步环境
uv sync

# 激活虚拟环境
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate
```

#### 4.2.2 使用pip安装

```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate

# 安装依赖
pip install -e .
```

#### 4.2.3 安装FFmpeg

- **Windows**：
  1. 从[FFmpeg官网](https://ffmpeg.org/download.html)下载Windows构建版本
  2. 将ffmpeg.exe和ffprobe.exe放在项目的`ffmpeg/`目录中或添加到系统PATH

- **macOS**：
  ```bash
  brew install ffmpeg
  ```

- **Linux**：
  ```bash
  # Ubuntu/Debian
  apt update && apt install -y ffmpeg
  
  # CentOS/RHEL
  yum install -y ffmpeg
  ```

### 4.3 验证安装

```bash
# 验证FFmpeg配置
python tests/test_ffmpeg_setup.py

# 运行示例
python example.py
```

## 5. 开发指南

### 5.1 代码贡献流程

1. **分支管理**
   - `main`：主分支，保持稳定
   - `develop`：开发分支，集成新功能
   - `feature/*`：功能开发分支
   - `bugfix/*`：bug修复分支

2. **提交规范**
   - 提交信息使用英文或中文，简明扼要描述修改内容
   - 格式：`<类型>: <描述>`，如`feat: 添加桌面GUI支持`
   - 类型包括：feat(新功能)、fix(修复bug)、docs(文档)、style(代码风格)、refactor(重构)、test(测试)、chore(杂项)

3. **代码规范**
   - 遵循PEP 8规范
   - 使用type hints标明参数和返回值类型
   - 关键函数和类添加docstring
   - 使用相对导入而非绝对导入

### 5.2 添加新功能

1. **核心功能扩展**
   - 在`core.py`中添加新方法或扩展现有功能
   - 为新功能创建相应的单元测试
   - 更新文档以反映新功能

2. **界面扩展**
   - Web界面：修改`app.py`
   - 桌面GUI：修改`desktop.py`
   - API服务：在`server/router.py`中添加新的路由

3. **模型更新**
   - 在`configs.py`中更新模型路径
   - 确保模型加载逻辑能处理更新
   - 添加模型自动下载机制

### 5.3 单元测试

```bash
# 运行所有测试
python -m unittest discover tests

# 运行特定测试
python -m unittest tests/test_detector.py
```

## 6. 部署说明

### 6.1 本地部署

#### 6.1.1 Web界面

```bash
# 使用uv
uv run streamlit run app.py

# 或使用pip
streamlit run app.py
```

访问 http://localhost:8501 查看Web界面

#### 6.1.2 桌面应用

```bash
# 使用uv
uv run python desktop.py

# 或使用pip
python desktop.py
```

#### 6.1.3 Web服务

```bash
# 使用uv
uv run python start_server.py

# 或使用pip
python start_server.py
```

服务默认在 http://localhost:5344 启动，API文档可在 http://localhost:5344/docs 访问

### 6.2 服务器部署

#### 6.2.1 使用Gunicorn和Nginx（Linux）

1. 安装Gunicorn
   ```bash
   pip install gunicorn uvicorn
   ```

2. 创建Gunicorn配置
   ```python
   # gunicorn_config.py
   bind = "0.0.0.0:5344"
   workers = 2
   worker_class = "uvicorn.workers.UvicornWorker"
   ```

3. 启动服务
   ```bash
   gunicorn -c gunicorn_config.py "sora2wm.server.router:app"
   ```

4. 配置Nginx反向代理
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       location / {
           proxy_pass http://localhost:5344;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

### 6.3 容器化部署

#### 6.3.1 使用Docker

```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \n    ffmpeg \n    gcc \n    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY . .

# 安装Python依赖
RUN pip install --no-cache-dir -e .

# 暴露端口
EXPOSE 5344

# 启动命令
CMD ["python", "start_server.py"]
```

构建和运行Docker容器：
```bash
docker build -t sora2wm .
docker run -p 5344:5344 sora2wm
```

## 7. 配置管理

### 7.1 配置文件

主要配置位于`sora2wm/configs.py`文件中：

```python
# 模型配置
YOLO_MODEL_PATH = "resources/best.pt"
YOLO_MODEL_URL = "https://github.com/linkedlist771/Sora2WatermarkRemover/releases/download/V0.0.1/best.pt"
LAMA_MODEL_URL = "https://github.com/Sanster/models/releases/download/add_big_lama/big-lama.pt"

# 视频处理配置
DEFAULT_OUTPUT_FORMAT = "mp4"
DEFAULT_ENCODER = "libx264"
DEFAULT_AUDIO_ENCODER = "aac"
DEFAULT_OUTPUT_DIR = "outputs"

# 性能配置
DEFAULT_BATCH_SIZE = 1
MAX_PROCESSING_THREADS = 4
```

### 7.2 环境变量

可以通过环境变量覆盖默认配置：

- `SORA2WM_YOLO_PATH`：YOLO模型路径
- `SORA2WM_OUTPUT_DIR`：输出目录
- `SORA2WM_BATCH_SIZE`：批处理大小
- `SORA2WM_SERVER_PORT`：服务器端口

## 8. 监控与维护

### 8.1 日志记录

系统使用Python内置的logging模块进行日志记录：

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger("Sora2WatermarkRemover")
```

### 8.2 常见问题排查

1. **FFmpeg未找到错误**
   - 检查FFmpeg是否安装
   - 验证FFmpeg路径是否正确
   - 运行`python tests/test_ffmpeg_setup.py`诊断

2. **模型下载失败**
   - 检查网络连接
   - 手动下载模型并放置到指定路径
   - 检查模型路径权限

3. **内存不足错误**
   - 减小视频分辨率
   - 降低批处理大小
   - 启用CPU模式（对于GPU内存不足）

4. **处理速度慢**
   - 确保启用GPU加速
   - 检查系统资源使用情况
   - 减小视频分辨率或帧率

## 9. 版本管理

### 9.1 版本号规范

使用语义化版本号：`MAJOR.MINOR.PATCH`

- `MAJOR`：不兼容的API变更
- `MINOR`：向后兼容的功能性新增
- `PATCH`：向后兼容的问题修复

### 9.2 发布流程

1. 更新版本号（在`__version__`中）
2. 更新CHANGELOG.md
3. 运行所有测试
4. 创建发布标签
5. 上传预训练模型（如有更新）
6. 发布新版本

## 10. 相关文档

- [产品设计PRD](产品设计PRD.md)：详细的产品需求说明
- [技术实现方案](技术实现方案.md)：系统架构和技术细节
- [README-zh.md](README-zh.md)：用户使用指南和项目概述